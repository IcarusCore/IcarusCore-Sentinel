{% extends "base.html" %}

{% block title %}TTPs - Tactics, Techniques & Procedures{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/filters.css') }}" rel="stylesheet">
<style>
    .filter-bar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .technique-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .technique-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .technique-card.severity-critical {
        border-left-color: #8b0000;
    }
    
    .technique-card.severity-high {
        border-left-color: #ff4444;
    }
    
    .technique-card.severity-medium {
        border-left-color: #ff8800;
    }
    
    .technique-card.severity-low {
        border-left-color: #4caf50;
    }
    
    .mitre-id {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        cursor: pointer;
    }
    
    .mitre-id:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-crosshairs text-primary me-3"></i>
            Tactics, Techniques & Procedures
        </h2>
        <p class="text-muted mb-0">Comprehensive database of threat actor TTPs based on MITRE ATT&CK and threat intelligence sources</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="exportFilteredResults()">
            <i class="fas fa-download me-2"></i>Export
        </button>
        <button class="btn btn-primary" onclick="refreshData()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Filter Bar -->
<form method="GET" action="{{ url_for('ttps') }}" id="filterForm">
    <div class="filter-bar p-4 mb-4">
        <div class="row g-3 align-items-end">
            <!-- Search Input -->
            <div class="col-md-4">
                <label for="searchInput" class="form-label small text-muted">Search Techniques</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" 
                           id="searchInput"
                           name="search"
                           class="form-control" 
                           placeholder="Search by name, description, or technique ID..."
                           value="{{ search_query or '' }}">
                </div>
            </div>
            
            <!-- Severity Filter -->
            <div class="col-md-2">
                <label for="severityFilter" class="form-label small text-muted">Severity</label>
                <select id="severityFilter" name="severity" class="form-select filter-select">
                    <option value="">All Severities</option>
                    <option value="Critical" {{ 'selected' if request.args.get('severity') == 'Critical' }}>Critical</option>
                    <option value="High" {{ 'selected' if request.args.get('severity') == 'High' }}>High</option>
                    <option value="Medium" {{ 'selected' if request.args.get('severity') == 'Medium' }}>Medium</option>
                    <option value="Low" {{ 'selected' if request.args.get('severity') == 'Low' }}>Low</option>
                </select>
            </div>
            
            <!-- Source Filter -->
            <div class="col-md-2">
                <label for="sourceFilter" class="form-label small text-muted">Source</label>
                <select id="sourceFilter" name="source" class="form-select filter-select">
                    <option value="">All Sources</option>
                    <option value="MITRE ATT&CK" {{ 'selected' if request.args.get('source') == 'MITRE ATT&CK' }}>MITRE ATT&CK</option>
                    <option value="CISA" {{ 'selected' if request.args.get('source') == 'CISA' }}>CISA</option>
                    <option value="AlienVault OTX" {{ 'selected' if request.args.get('source') == 'AlienVault OTX' }}>AlienVault OTX</option>
                    <option value="RSS" {{ 'selected' if request.args.get('source') == 'RSS' }}>Security News</option>
                </select>
            </div>
            
            <!-- Tactic Filter -->
            <div class="col-md-2">
                <label for="tacticFilter" class="form-label small text-muted">Tactic</label>
                <select id="tacticFilter" name="tactic" class="form-select filter-select">
                    <option value="">All Tactics</option>
                    {% for tactic in tactics %}
                    <option value="{{ tactic }}" {{ 'selected' if current_tactic == tactic }}>
                        {{ tactic|title|replace('-', ' ') }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="col-md-2">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Search
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearAllFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Results Summary -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="results-summary">
        <span class="results-count text-muted">
            {% if threats %}
                {% if search_query or request.args.get('severity') or request.args.get('source') or current_tactic %}
                    Found {{ pagination.total if pagination else threats|length }} matching techniques
                {% else %}
                    Showing {{ threats|length }} of {{ pagination.total if pagination else threats|length }} techniques
                {% endif %}
            {% else %}
                No techniques found
            {% endif %}
        </span>
    </div>
</div>

<!-- Techniques List -->
<div id="techniquesContainer" class="techniques-list">
    {% if threats %}
        <!-- Table View -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Technique</th>
                        <th>Tactic</th>
                        <th>Severity</th>
                        <th>Source</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for threat in threats %}
                    <tr class="technique-row">
                        <td>
                            {% if threat.id and threat.id.startswith('T') %}
                            <code class="mitre-id" onclick="copyToClipboard('{{ threat.id }}')">
                                {{ threat.id }}
                            </code>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <strong>{{ threat.name }}</strong>
                                <br>
                                <small class="text-muted">{{ threat.description|truncate_text(120) }}</small>
                                {% if threat.platforms %}
                                <div class="mt-1">
                                    {% for platform in threat.platforms[:3] %}
                                    <span class="badge bg-info me-1">{{ platform }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if threat.tags %}
                                <div class="mt-1">
                                    {% for tag in threat.tags[:4] %}
                                    <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-secondary">
                                {{ threat.tactic|title|replace('-', ' ') if threat.tactic else 'Unknown' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge severity-{{ threat.severity|lower }}">
                                {{ threat.severity }}
                            </span>
                        </td>
                        <td>
                            <span class="badge source-{{ threat.source|lower|replace(' ', '-') }}">
                                {{ threat.source }}
                            </span>
                        </td>
                        <td>
                            <small>{{ threat.date|format_date }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if threat.id and threat.id.startswith('T') %}
                                <button class="btn btn-outline-primary" 
                                        onclick="openMitreLink('{{ threat.id }}')"
                                        title="MITRE ATT&CK">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-info" 
                                        onclick="showThreatDetails('{{ threat.id or loop.index }}')"
                                        title="View Details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-5">
            <div class="empty-state">
                <i class="fas fa-crosshairs fa-4x text-muted mb-4 opacity-50"></i>
                <h4>No Techniques Found</h4>
                <p class="text-muted mb-4">
                    {% if search_query or request.args.get('severity') or request.args.get('source') or current_tactic %}
                        No techniques match your search criteria. Try adjusting your filters.
                    {% else %}
                        No threat intelligence data has been loaded yet.
                    {% endif %}
                </p>
                <div class="d-flex gap-2 justify-content-center">
                    {% if search_query or request.args.get('severity') or request.args.get('source') or current_tactic %}
                    <button class="btn btn-outline-primary" onclick="clearAllFilters()">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </button>
                    {% endif %}
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Techniques pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- Previous Page -->
        {% if pagination.page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page - 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if request.args.get('severity') %}&severity={{ request.args.get('severity') }}{% endif %}{% if request.args.get('source') %}&source={{ request.args.get('source') }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                <i class="fas fa-chevron-left"></i> Previous
            </a>
        </li>
        {% endif %}
        
        <!-- Page Numbers -->
        {% set start_page = [pagination.page - 2, 1]|max %}
        {% set end_page = [pagination.page + 2, pagination.pages]|min %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
            <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if request.args.get('severity') %}&severity={{ request.args.get('severity') }}{% endif %}{% if request.args.get('source') %}&source={{ request.args.get('source') }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                {{ page_num }}
            </a>
        </li>
        {% endfor %}
        
        <!-- Next Page -->
        {% if pagination.page < pagination.pages %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page + 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if request.args.get('severity') %}&severity={{ request.args.get('severity') }}{% endif %}{% if request.args.get('source') %}&source={{ request.args.get('source') }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Threat Details Modal -->
<div class="modal fade" id="threatDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Threat Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="threatDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form on filter change for better UX
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const searchInput = document.getElementById('searchInput');
    const selects = document.querySelectorAll('.filter-select');
    
    // Auto-submit on dropdown change
    selects.forEach(select => {
        select.addEventListener('change', function() {
            filterForm.submit();
        });
    });
    
    // Debounced search submission
    let searchTimeout;
    searchInput?.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            // Only auto-submit if there's a value or if clearing
            if (this.value.length >= 3 || this.value.length === 0) {
                filterForm.submit();
            }
        }, 500);
    });
    
    // Handle Enter key in search
    searchInput?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(searchTimeout);
            filterForm.submit();
        }
    });
});

function clearAllFilters() {
    // Clear all form inputs
    document.getElementById('searchInput').value = '';
    document.getElementById('severityFilter').value = '';
    document.getElementById('sourceFilter').value = '';
    document.getElementById('tacticFilter').value = '';
    
    // Submit the form to clear server-side filters
    document.getElementById('filterForm').submit();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show toast or alert
        if (window.ThreatDashboard && window.ThreatDashboard.showAlert) {
            window.ThreatDashboard.showAlert('Copied to clipboard!', 'success', 2000);
        }
    });
}

function showThreatDetails(threatId) {
    const modal = new bootstrap.Modal(document.getElementById('threatDetailsModal'));
    const content = document.getElementById('threatDetailsContent');
    
    // Show loading state
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading threat details...</p>
        </div>
    `;
    
    modal.show();
    
    // Fetch details via AJAX
    fetch(`/api/threat/${threatId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load threat details');
            }
            return response.json();
        })
        .then(data => {
            // Build detailed view
            let platformsHtml = '';
            if (data.platforms && data.platforms.length > 0) {
                platformsHtml = `
                    <div class="mb-3">
                        <h6>Platforms</h6>
                        <div>
                            ${data.platforms.map(p => `<span class="badge bg-info me-1">${p}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            let tagsHtml = '';
            if (data.tags && data.tags.length > 0) {
                tagsHtml = `
                    <div class="mb-3">
                        <h6>Tags</h6>
                        <div>
                            ${data.tags.map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            let techniquesHtml = '';
            if (data.techniques && data.techniques.length > 0) {
                techniquesHtml = `
                    <div class="mb-3">
                        <h6>Associated Techniques</h6>
                        <div>
                            ${data.techniques.map(t => `<span class="badge bg-danger me-1">${t}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            let detectionHtml = '';
            if (data.detection) {
                detectionHtml = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-shield-alt me-2"></i>Detection</h6>
                        <p class="mb-0">${data.detection}</p>
                    </div>
                `;
            }
            
            let mitigationHtml = '';
            if (data.mitigation) {
                mitigationHtml = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-tools me-2"></i>Mitigation</h6>
                        <p class="mb-0">${data.mitigation}</p>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="threat-details">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h4>${data.name || 'Unknown Threat'}</h4>
                            ${data.id ? `<p class="text-muted">ID: <code>${data.id}</code></p>` : ''}
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge severity-${(data.severity || 'unknown').toLowerCase()} fs-6">
                                ${data.severity || 'Unknown'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Description</h6>
                        <p>${data.description || 'No description available'}</p>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h6>Tactic</h6>
                            <span class="badge bg-secondary">
                                ${data.tactic ? data.tactic.replace('-', ' ') : 'Unknown'}
                            </span>
                        </div>
                        <div class="col-md-4">
                            <h6>Source</h6>
                            <span class="badge bg-info">${data.source || 'Unknown'}</span>
                        </div>
                        <div class="col-md-4">
                            <h6>Date</h6>
                            <small>${data.date || 'Unknown'}</small>
                        </div>
                    </div>
                    
                    ${platformsHtml}
                    ${tagsHtml}
                    ${techniquesHtml}
                    ${detectionHtml}
                    ${mitigationHtml}
                    
                    ${data.link ? `
                    <div class="mt-3">
                        <h6>External Resources</h6>
                        <a href="${data.link}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>View Original Source
                        </a>
                    </div>
                    ` : ''}
                    
                    ${data.id && data.id.startsWith('T') ? `
                    <div class="mt-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="openMitreLink('${data.id}')">
                            <i class="fas fa-external-link-alt me-1"></i>View on MITRE ATT&CK
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error loading threat details:', error);
            content.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Unable to load threat details. Please try again later.
                </div>
            `;
        });
}

function openMitreLink(techniqueId) {
    if (!techniqueId) return;
    
    let url;
    if (techniqueId.includes('.')) {
        const [main, sub] = techniqueId.split('.');
        url = `https://attack.mitre.org/techniques/${main}/${sub}/`;
    } else {
        url = `https://attack.mitre.org/techniques/${techniqueId}/`;
    }
    
    window.open(url, '_blank', 'noopener,noreferrer');
}

function exportFilteredResults() {
    // Get current filter parameters
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'true');
    
    // Open export URL in new window
    window.open(`/api/export/ttps?${params.toString()}`, '_blank');
}

// Make functions globally available
window.clearAllFilters = clearAllFilters;
window.copyToClipboard = copyToClipboard;
window.showThreatDetails = showThreatDetails;
window.openMitreLink = openMitreLink;
window.exportFilteredResults = exportFilteredResults;
</script>
{% endblock %}