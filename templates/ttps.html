{% extends "base.html" %}

{% block title %}TTPs - Tactics, Techniques & Procedures{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/filters.css') }}" rel="stylesheet">
<style>
    .filter-bar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .technique-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .technique-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .technique-card.severity-critical {
        border-left-color: #8b0000;
    }
    
    .technique-card.severity-high {
        border-left-color: #ff4444;
    }
    
    .technique-card.severity-medium {
        border-left-color: #ff8800;
    }
    
    .technique-card.severity-low {
        border-left-color: #4caf50;
    }
    
    .mitre-id {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        cursor: pointer;
    }
    
    .mitre-id:hover {
        text-decoration: underline;
    }
    
    .tactic-filter-pills .nav-link {
        border-radius: 20px;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .tactic-filter-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-crosshairs text-primary me-3"></i>
            Tactics, Techniques & Procedures
        </h2>
        <p class="text-muted mb-0">Comprehensive database of threat actor TTPs based on MITRE ATT&CK and threat intelligence sources</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="exportFilteredResults()">
            <i class="fas fa-download me-2"></i>Export
        </button>
        <button class="btn btn-primary" onclick="refreshData()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar p-4 mb-4">
    <div class="row g-3 align-items-end">
        <!-- Search Input -->
        <div class="col-md-4">
            <label for="searchInput" class="form-label small text-muted">Search Techniques</label>
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" 
                       id="searchInput"
                       class="form-control" 
                       placeholder="Search by name, description, or technique ID..."
                       value="{{ search_query or '' }}">
            </div>
            <div class="search-suggestions" style="display: none;"></div>
        </div>
        
        <!-- Severity Filter -->
        <div class="col-md-2">
            <label for="severityFilter" class="form-label small text-muted">Severity</label>
            <select id="severityFilter" class="form-select filter-select">
                <option value="">All Severities</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        
        <!-- Source Filter -->
        <div class="col-md-2">
            <label for="sourceFilter" class="form-label small text-muted">Source</label>
            <select id="sourceFilter" class="form-select filter-select">
                <option value="">All Sources</option>
                <option value="MITRE ATT&CK">MITRE ATT&CK</option>
                <option value="CISA">CISA</option>
                <option value="AlienVault OTX">AlienVault OTX</option>
                <option value="RSS">Security News</option>
            </select>
        </div>
        
        <!-- Tactic Filter -->
        <div class="col-md-2">
            <label for="tacticFilter" class="form-label small text-muted">Tactic</label>
            <select id="tacticFilter" class="form-select filter-select">
                <option value="">All Tactics</option>
                {% for tactic in tactics %}
                <option value="{{ tactic }}">
                    {{ tactic|title|replace('-', ' ') }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Action Buttons -->
        <div class="col-md-2">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary clear-filters" onclick="clearAllFilters()">
                    <i class="fas fa-times me-1"></i>Clear
                </button>
            </div>
        </div>
    </div>
    
    <!-- Advanced Filters section removed -->
</div>

<!-- Results Summary - Hidden -->
<div class="d-flex justify-content-between align-items-center mb-3" style="display: none !important;">
    <div class="results-summary">
        <span class="results-count text-muted">
            {% if threats %}
                Showing {{ threats|length }} techniques
            {% else %}
                No techniques found
            {% endif %}
        </span>
    </div>
    <div class="pagination-info">
        <span class="text-muted" id="paginationInfo">Page 1</span>
    </div>
</div>

<!-- MITRE ATT&CK Tactic Pills - REMOVED SECTION -->
<!-- The tactic pills section has been removed as requested -->

<!-- Techniques List -->
<div id="techniquesContainer" class="techniques-list">
    {% if threats %}
        <!-- Table View Only -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Technique</th>
                        <th>Tactic</th>
                        <th>Severity</th>
                        <th>Source</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for threat in threats %}
                    <tr class="technique-row"
                        data-severity="{{ threat.severity }}"
                        data-source="{{ threat.source }}"
                        data-tactic="{{ threat.tactic }}"
                        data-date="{{ threat.date }}"
                        data-id="{{ threat.id }}">
                        <td>
                            {% if threat.id and threat.id.startswith('T') %}
                            <code class="mitre-id" onclick="copyToClipboard('{{ threat.id }}')">
                                {{ threat.id }}
                            </code>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <strong>{{ threat.name }}</strong>
                                <br>
                                <small class="text-muted">{{ threat.description|truncate_text(120) }}</small>
                                {% if threat.platforms %}
                                <div class="mt-1">
                                    {% for platform in threat.platforms[:3] %}
                                    <span class="badge bg-info me-1">{{ platform }}</span>
                                    {% endfor %}
                                    {% if threat.platforms|length > 3 %}
                                    <span class="badge bg-light text-dark">+{{ threat.platforms|length - 3 }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% if threat.tags %}
                                <div class="mt-1">
                                    {% for tag in threat.tags[:4] %}
                                    <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                                    {% endfor %}
                                    {% if threat.tags|length > 4 %}
                                    <span class="badge bg-secondary">+{{ threat.tags|length - 4 }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-secondary">
                                {{ threat.tactic|title|replace('-', ' ') if threat.tactic else 'Unknown' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge severity-{{ threat.severity|lower }}">
                                {{ threat.severity }}
                            </span>
                        </td>
                        <td>
                            <span class="badge source-{{ threat.source|lower|replace(' ', '-') }}">
                                {{ threat.source }}
                            </span>
                        </td>
                        <td>
                            <small>{{ threat.date|format_date }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if threat.id and threat.id.startswith('T') %}
                                <button class="btn btn-outline-primary" 
                                        onclick="openMitreLink('{{ threat.id }}')"
                                        title="MITRE ATT&CK">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                                {% endif %}
                                {% if threat.link %}
                                <button class="btn btn-outline-secondary"
                                        onclick="openExternalLink('{{ threat.link }}')"
                                        title="Source">
                                    <i class="fas fa-link"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-info" 
                                        onclick="showThreatDetails('{{ threat.id or loop.index }}')"
                                        title="View Details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-5" id="emptyState" style="display: none;">
            <div class="empty-state">
                <i class="fas fa-crosshairs fa-4x text-muted mb-4 opacity-50"></i>
                <h4>No Techniques Found</h4>
                <p class="text-muted mb-4">
                    {% if search_query or current_tactic %}
                        No techniques match your current filters. Try adjusting your search criteria.
                    {% else %}
                        No threat intelligence data has been loaded yet.
                    {% endif %}
                </p>
                <div class="d-flex gap-2 justify-content-center">
                    {% if search_query or current_tactic %}
                    <button class="btn btn-outline-primary" onclick="clearAllFilters()">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </button>
                    {% endif %}
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Pagination Controls - Hidden -->
<div class="d-flex justify-content-center align-items-center mt-4" id="paginationControls" style="display: none !important;">
    <nav aria-label="Techniques pagination">
        <ul class="pagination" id="pagination">
            <!-- Pagination will be generated by JavaScript -->
        </ul>
    </nav>
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Techniques pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- Previous Page -->
        {% if pagination.page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page - 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                <i class="fas fa-chevron-left"></i> Previous
            </a>
        </li>
        {% endif %}
        
        <!-- Page Numbers -->
        {% set start_page = [pagination.page - 2, 1]|max %}
        {% set end_page = [pagination.page + 2, pagination.pages]|min %}
        
        {% if start_page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
            <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                {{ page_num }}
            </a>
        </li>
        {% endfor %}
        
        {% if end_page < pagination.pages %}
        {% if end_page < pagination.pages - 1 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                {{ pagination.pages }}
            </a>
        </li>
        {% endif %}
        
        <!-- Next Page -->
        {% if pagination.page < pagination.pages %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page + 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Threat Details Modal -->
<div class="modal fade" id="threatDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Threat Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="threatDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple, working TTP filtering - no external dependencies
let currentFilters = {
    search: '',
    severity: '',
    source: '',
    tactic: ''
};

let currentPage = 1;
const itemsPerPage = 20;
let allRows = [];
let filteredRows = [];

// Initialize when page loads
window.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing filters...');
    
    // Get ALL table rows from the entire document
    allRows = Array.from(document.querySelectorAll('.technique-row'));
    filteredRows = [...allRows];
    
    console.log('Found', allRows.length, 'total rows to search through');
    
    if (allRows.length > 0) {
        console.log('Sample row:', allRows[0].dataset);
        console.log('Sample search text:', [
            allRows[0].querySelector('strong')?.textContent || '',
            allRows[0].querySelector('small.text-muted')?.textContent || '',
            allRows[0].querySelector('.mitre-id')?.textContent || ''
        ].join(' '));
    }
    
    // Set up search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.oninput = function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentFilters.search = this.value.toLowerCase().trim();
                console.log('Search term:', currentFilters.search);
                filterAndDisplay();
            }, 300);
        };
        console.log('Search input set up');
    }
    
    // Set up severity filter
    const severityFilter = document.getElementById('severityFilter');
    if (severityFilter) {
        severityFilter.onchange = function() {
            currentFilters.severity = this.value;
            console.log('Severity changed to:', this.value);
            filterAndDisplay();
        };
        console.log('Severity filter set up');
    }
    
    // Set up source filter
    const sourceFilter = document.getElementById('sourceFilter');
    if (sourceFilter) {
        sourceFilter.onchange = function() {
            currentFilters.source = this.value;
            console.log('Source changed to:', this.value);
            filterAndDisplay();
        };
        console.log('Source filter set up');
    }
    
    // Set up tactic filter
    const tacticFilter = document.getElementById('tacticFilter');
    if (tacticFilter) {
        tacticFilter.onchange = function() {
            currentFilters.tactic = this.value;
            console.log('Tactic changed to:', this.value);
            filterAndDisplay();
        };
        console.log('Tactic filter set up');
    }
    
    // Initial display - show all rows
    console.log('Showing all', allRows.length, 'rows initially');
    allRows.forEach(row => {
        row.style.display = 'table-row';
    });
});

function filterAndDisplay() {
    console.log('Filtering with:', currentFilters);
    
    // Filter ALL rows, not just the first page
    filteredRows = allRows.filter(row => {
        // Search filter
        if (currentFilters.search) {
            const searchText = [
                row.querySelector('strong')?.textContent || '',
                row.querySelector('small.text-muted')?.textContent || '',
                row.querySelector('.mitre-id')?.textContent || ''
            ].join(' ').toLowerCase();
            
            if (!searchText.includes(currentFilters.search)) {
                return false;
            }
        }
        
        // Severity filter
        if (currentFilters.severity) {
            if (row.dataset.severity !== currentFilters.severity) {
                return false;
            }
        }
        
        // Source filter  
        if (currentFilters.source) {
            const rowSource = row.dataset.source;
            if (currentFilters.source === 'RSS') {
                // Handle RSS sources
                const rssNames = ['BleepingComputer', 'Krebs on Security', 'The Hacker News'];
                if (!rssNames.includes(rowSource)) {
                    return false;
                }
            } else if (rowSource !== currentFilters.source) {
                return false;
            }
        }
        
        // Tactic filter
        if (currentFilters.tactic) {
            if (row.dataset.tactic !== currentFilters.tactic) {
                return false;
            }
        }
        
        return true;
    });
    
    console.log('Filtered to', filteredRows.length, 'rows out of', allRows.length, 'total rows');
    
    // Update display to show ALL filtered results
    updateDisplay();
}

function updateDisplay() {
    // Show all filtered rows (no pagination)
    allRows.forEach(row => {
        row.style.display = 'none';
    });
    
    // Show all filtered rows
    filteredRows.forEach(row => {
        row.style.display = 'table-row';
    });
    
    // Handle empty state
    const tableContainer = document.querySelector('.table-responsive');
    const emptyState = document.getElementById('emptyState');
    
    if (filteredRows.length === 0) {
        if (tableContainer) tableContainer.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
    } else {
        if (tableContainer) tableContainer.style.display = 'block';
        if (emptyState) emptyState.style.display = 'none';
    }
}

function updateCount() {
    // Results count hidden - no longer displayed
    return;
}

function updatePagination() {
    // Pagination hidden - no longer displayed
    return;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateDisplay();
        updatePagination();
        updateCount();
    }
}

function clearAllFilters() {
    console.log('Clearing all filters');
    
    currentFilters = {
        search: '',
        severity: '',
        source: '',
        tactic: ''
    };
    
    currentPage = 1;
    
    // Reset form controls
    const searchInput = document.getElementById('searchInput');
    const severityFilter = document.getElementById('severityFilter');
    const sourceFilter = document.getElementById('sourceFilter');
    const tacticFilter = document.getElementById('tacticFilter');
    
    if (searchInput) searchInput.value = '';
    if (severityFilter) severityFilter.value = '';
    if (sourceFilter) sourceFilter.value = '';
    if (tacticFilter) tacticFilter.value = '';
    
    filterAndDisplay();
}

function showThreatDetails(threatId) {
    const modal = new bootstrap.Modal(document.getElementById('threatDetailsModal'));
    const content = document.getElementById('threatDetailsContent');
    
    const threatRow = document.querySelector(`[data-id="${threatId}"]`);
    if (!threatRow) return;
    
    const threatName = threatRow.querySelector('strong')?.textContent || 'Unknown';
    const threatDesc = threatRow.querySelector('small.text-muted')?.textContent || 'No description available';
    const severity = threatRow.dataset.severity || 'Unknown';
    const source = threatRow.dataset.source || 'Unknown';
    const tactic = threatRow.dataset.tactic || 'Unknown';
    const mitreId = threatRow.querySelector('.mitre-id')?.textContent || '';
    
    content.innerHTML = `
        <div class="threat-details">
            <div class="row mb-3">
                <div class="col-md-8">
                    <h4>${threatName}</h4>
                    ${mitreId ? `<p class="text-muted">MITRE ATT&CK ID: <code>${mitreId}</code></p>` : ''}
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge severity-${severity.toLowerCase()} fs-6">${severity}</span>
                </div>
            </div>
            
            <div class="mb-4">
                <h6>Description</h6>
                <p>${threatDesc}</p>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <h6>Tactic</h6>
                    <span class="badge bg-secondary">${tactic.replace('-', ' ')}</span>
                </div>
                <div class="col-md-4">
                    <h6>Source</h6>
                    <span class="badge bg-info">${source}</span>
                </div>
                <div class="col-md-4">
                    <h6>Severity</h6>
                    <span class="badge severity-${severity.toLowerCase()}">${severity}</span>
                </div>
            </div>
            
            ${mitreId ? `
            <div class="mb-3">
                <h6>External Resources</h6>
                <button class="btn btn-outline-primary btn-sm" onclick="openMitreLink('${mitreId}')">
                    <i class="fas fa-external-link-alt me-1"></i>View on MITRE ATT&CK
                </button>
            </div>
            ` : ''}
        </div>
    `;
    
    modal.show();
}

function openMitreLink(techniqueId) {
    if (!techniqueId) return;
    
    let url;
    if (techniqueId.includes('.')) {
        const [main, sub] = techniqueId.split('.');
        url = `https://attack.mitre.org/techniques/${main}/${sub}/`;
    } else {
        url = `https://attack.mitre.org/techniques/${techniqueId}/`;
    }
    
    window.open(url, '_blank', 'noopener,noreferrer');
}

// Make functions globally available
window.clearAllFilters = clearAllFilters;
window.changePage = changePage;
window.showThreatDetails = showThreatDetails;
window.openMitreLink = openMitreLink;
</script>
{% endblock %}