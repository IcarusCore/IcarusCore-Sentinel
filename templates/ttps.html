{% extends "base.html" %}

{% block title %}TTPs - Tactics, Techniques & Procedures{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/filters.css') }}" rel="stylesheet">
<style>
    .filter-bar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .technique-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .technique-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .technique-card.severity-critical {
        border-left-color: #8b0000;
    }
    
    .technique-card.severity-high {
        border-left-color: #ff4444;
    }
    
    .technique-card.severity-medium {
        border-left-color: #ff8800;
    }
    
    .technique-card.severity-low {
        border-left-color: #4caf50;
    }
    
    .mitre-id {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        cursor: pointer;
    }
    
    .mitre-id:hover {
        text-decoration: underline;
    }
    
    .tactic-filter-pills .nav-link {
        border-radius: 20px;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .tactic-filter-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-crosshairs text-primary me-3"></i>
            Tactics, Techniques & Procedures
        </h2>
        <p class="text-muted mb-0">Comprehensive database of threat actor TTPs based on MITRE ATT&CK and threat intelligence sources</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="exportFilteredResults()">
            <i class="fas fa-download me-2"></i>Export
        </button>
        <button class="btn btn-primary" onclick="refreshData()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar p-4 mb-4">
    <form class="search-form" method="GET">
        <div class="row g-3 align-items-end">
            <!-- Search Input -->
            <div class="col-md-4">
                <label for="searchInput" class="form-label small text-muted">Search Techniques</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" 
                           id="searchInput"
                           name="search" 
                           class="form-control" 
                           placeholder="Search by name, description, or technique ID..."
                           value="{{ search_query or '' }}">
                </div>
                <div class="search-suggestions" style="display: none;"></div>
            </div>
            
            <!-- Severity Filter -->
            <div class="col-md-2">
                <label for="severityFilter" class="form-label small text-muted">Severity</label>
                <select id="severityFilter" name="severity" class="form-select filter-select">
                    <option value="">All Severities</option>
                    <option value="Critical" {{ 'selected' if request.args.get('severity') == 'Critical' }}>Critical</option>
                    <option value="High" {{ 'selected' if request.args.get('severity') == 'High' }}>High</option>
                    <option value="Medium" {{ 'selected' if request.args.get('severity') == 'Medium' }}>Medium</option>
                    <option value="Low" {{ 'selected' if request.args.get('severity') == 'Low' }}>Low</option>
                </select>
            </div>
            
            <!-- Source Filter -->
            <div class="col-md-2">
                <label for="sourceFilter" class="form-label small text-muted">Source</label>
                <select id="sourceFilter" name="source" class="form-select filter-select">
                    <option value="">All Sources</option>
                    <option value="MITRE ATT&CK" {{ 'selected' if request.args.get('source') == 'MITRE ATT&CK' }}>MITRE ATT&CK</option>
                    <option value="CISA" {{ 'selected' if request.args.get('source') == 'CISA' }}>CISA</option>
                    <option value="AlienVault OTX" {{ 'selected' if request.args.get('source') == 'AlienVault OTX' }}>AlienVault OTX</option>
                    <option value="RSS" {{ 'selected' if request.args.get('source') and 'RSS' in request.args.get('source') }}>Security News</option>
                </select>
            </div>
            
            <!-- Tactic Filter -->
            <div class="col-md-2">
                <label for="tacticFilter" class="form-label small text-muted">Tactic</label>
                <select id="tacticFilter" name="tactic" class="form-select filter-select">
                    <option value="">All Tactics</option>
                    {% for tactic in tactics %}
                    <option value="{{ tactic }}" {{ 'selected' if current_tactic == tactic }}>
                        {{ tactic|title|replace('-', ' ') }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="col-md-2">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i>Filter
                    </button>
                    <button type="button" class="btn btn-outline-secondary clear-filters" onclick="clearAllFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Advanced Filters Toggle -->
    <div class="mt-3">
        <button class="btn btn-sm btn-outline-primary advanced-filters-toggle" onclick="toggleAdvancedFilters()">
            <i class="fas fa-chevron-down me-1"></i>Show Advanced Filters
        </button>
    </div>
    
    <!-- Advanced Filters Panel -->
    <div class="advanced-filters mt-3" style="display: none;">
        <div class="border-top pt-3">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Date Range</label>
                    <select name="dateRange" class="form-select form-select-sm">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                        <option value="quarter">Last Quarter</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Sort By</label>
                    <select name="sortBy" class="form-select form-select-sm">
                        <option value="date">Date</option>
                        <option value="name">Name</option>
                        <option value="severity">Severity</option>
                        <option value="source">Source</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Order</label>
                    <select name="sortOrder" class="form-select form-select-sm">
                        <option value="desc">Newest First</option>
                        <option value="asc">Oldest First</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Quick Filters</label>
                    <div class="filter-presets"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Summary -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="results-summary">
        <span class="results-count text-muted">
            Showing {{ threats|length }} of {{ threats|length }} techniques
        </span>
    </div>
    <div class="view-options">
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary active" id="cardView">
                <i class="fas fa-th-large"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="tableView">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>
</div>

<!-- MITRE ATT&CK Tactic Pills -->
{% if tactics %}
<div class="tactic-filter-pills mb-4">
    <div class="d-flex flex-wrap">
        <a href="{{ url_for('ttps') }}" class="nav-link {{ 'active' if not current_tactic else '' }}">
            All Tactics
        </a>
        {% for tactic in tactics %}
        <a href="{{ url_for('ttps') }}?tactic={{ tactic }}" 
           class="nav-link {{ 'active' if current_tactic == tactic else '' }}">
            {{ tactic|title|replace('-', ' ') }}
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Techniques List -->
<div id="techniquesContainer" class="techniques-list">
    {% if threats %}
        <div class="row" id="cardViewContainer">
            {% for threat in threats %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card technique-card h-100 severity-{{ threat.severity|lower }}"
                     data-severity="{{ threat.severity }}"
                     data-source="{{ threat.source }}"
                     data-tactic="{{ threat.tactic }}"
                     data-date="{{ threat.date }}"
                     data-id="{{ threat.id }}">
                    <div class="card-body">
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                {% if threat.id and threat.id.startswith('T') %}
                                <div class="mitre-id text-primary mb-1" 
                                     onclick="copyToClipboard('{{ threat.id }}')"
                                     title="Click to copy technique ID">
                                    {{ threat.id }}
                                </div>
                                {% endif %}
                                <h6 class="card-title mb-0">{{ threat.name }}</h6>
                            </div>
                            <div class="technique-badges">
                                <span class="badge severity-{{ threat.severity|lower }}">
                                    {{ threat.severity }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <p class="card-text text-muted small mb-3">
                            {{ threat.description|truncate_text(120) }}
                        </p>
                        
                        <!-- Tactic -->
                        {% if threat.tactic %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-crosshairs me-1"></i>
                                <strong>Tactic:</strong> {{ threat.tactic|title|replace('-', ' ') }}
                            </small>
                        </div>
                        {% endif %}
                        
                        <!-- Platforms -->
                        {% if threat.platforms %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-desktop me-1"></i>
                                <strong>Platforms:</strong>
                            </small>
                            <div class="mt-1">
                                {% for platform in threat.platforms[:3] %}
                                <span class="badge bg-info me-1">{{ platform }}</span>
                                {% endfor %}
                                {% if threat.platforms|length > 3 %}
                                <span class="badge bg-light text-dark">+{{ threat.platforms|length - 3 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Tags -->
                        {% if threat.tags %}
                        <div class="mb-3">
                            <div class="technique-tags">
                                {% for tag in threat.tags[:4] %}
                                <span class="badge bg-light text-dark me-1 mb-1">{{ tag }}</span>
                                {% endfor %}
                                {% if threat.tags|length > 4 %}
                                <span class="badge bg-secondary">+{{ threat.tags|length - 4 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Footer -->
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ threat.date|format_date }}
                                </small>
                                <span class="badge source-{{ threat.source|lower|replace(' ', '-') }}">
                                    {{ threat.source }}
                                </span>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="mt-2 d-flex gap-1">
                                {% if threat.id and threat.id.startswith('T') %}
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="openMitreLink('{{ threat.id }}')"
                                        title="View on MITRE ATT&CK">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                                {% endif %}
                                {% if threat.link %}
                                <button class="btn btn-sm btn-outline-secondary"
                                        onclick="openExternalLink('{{ threat.link }}')"
                                        title="View Source">
                                    <i class="fas fa-link"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="showThreatDetails('{{ threat.id or loop.index }}')"
                                        title="View Details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Table View (Hidden by default) -->
        <div id="tableViewContainer" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th class="sortable-header" data-sort="id">
                                ID <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th class="sortable-header" data-sort="name">
                                Technique <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th class="sortable-header" data-sort="tactic">
                                Tactic <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th class="sortable-header" data-sort="severity">
                                Severity <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th class="sortable-header" data-sort="source">
                                Source <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th class="sortable-header" data-sort="date">
                                Date <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for threat in threats %}
                        <tr class="technique-row"
                            data-severity="{{ threat.severity }}"
                            data-source="{{ threat.source }}"
                            data-tactic="{{ threat.tactic }}"
                            data-date="{{ threat.date }}">
                            <td>
                                {% if threat.id and threat.id.startswith('T') %}
                                <code class="mitre-id" onclick="copyToClipboard('{{ threat.id }}')">
                                    {{ threat.id }}
                                </code>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>
                                    <strong>{{ threat.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ threat.description|truncate_text(80) }}</small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary">
                                    {{ threat.tactic|title|replace('-', ' ') if threat.tactic else 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                <span class="badge severity-{{ threat.severity|lower }}">
                                    {{ threat.severity }}
                                </span>
                            </td>
                            <td>
                                <span class="badge source-{{ threat.source|lower|replace(' ', '-') }}">
                                    {{ threat.source }}
                                </span>
                            </td>
                            <td>
                                <small>{{ threat.date|format_date }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if threat.id and threat.id.startswith('T') %}
                                    <button class="btn btn-outline-primary" 
                                            onclick="openMitreLink('{{ threat.id }}')"
                                            title="MITRE ATT&CK">
                                        <i class="fas fa-external-link-alt"></i>
                                    </button>
                                    {% endif %}
                                    {% if threat.link %}
                                    <button class="btn btn-outline-secondary"
                                            onclick="openExternalLink('{{ threat.link }}')"
                                            title="Source">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-5">
            <div class="empty-state">
                <i class="fas fa-crosshairs fa-4x text-muted mb-4 opacity-50"></i>
                <h4>No Techniques Found</h4>
                <p class="text-muted mb-4">
                    {% if search_query or current_tactic %}
                        No techniques match your current filters. Try adjusting your search criteria.
                    {% else %}
                        No threat intelligence data has been loaded yet.
                    {% endif %}
                </p>
                <div class="d-flex gap-2 justify-content-center">
                    {% if search_query or current_tactic %}
                    <button class="btn btn-outline-primary" onclick="clearAllFilters()">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </button>
                    {% endif %}
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="Techniques pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- Previous Page -->
        {% if pagination.page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page - 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                <i class="fas fa-chevron-left"></i> Previous
            </a>
        </li>
        {% endif %}
        
        <!-- Page Numbers -->
        {% set start_page = [pagination.page - 2, 1]|max %}
        {% set end_page = [pagination.page + 2, pagination.pages]|min %}
        
        {% if start_page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
            <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                {{ page_num }}
            </a>
        </li>
        {% endfor %}
        
        {% if end_page < pagination.pages %}
        {% if end_page < pagination.pages - 1 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                {{ pagination.pages }}
            </a>
        </li>
        {% endif %}
        
        <!-- Next Page -->
        {% if pagination.page < pagination.pages %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.page + 1 }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_tactic %}&tactic={{ current_tactic }}{% endif %}">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Threat Details Modal -->
<div class="modal fade" id="threatDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Threat Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="threatDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/filters.js') }}"></script>
<script>
// View toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const cardViewBtn = document.getElementById('cardView');
    const tableViewBtn = document.getElementById('tableView');
    const cardContainer = document.getElementById('cardViewContainer');
    const tableContainer = document.getElementById('tableViewContainer');
    
    cardViewBtn?.addEventListener('click', function() {
        cardViewBtn.classList.add('active');
        tableViewBtn.classList.remove('active');
        cardContainer.style.display = 'block';
        tableContainer.style.display = 'none';
        localStorage.setItem('ttpsView', 'card');
    });
    
    tableViewBtn?.addEventListener('click', function() {
        tableViewBtn.classList.add('active');
        cardViewBtn.classList.remove('active');
        cardContainer.style.display = 'none';
        tableContainer.style.display = 'block';
        localStorage.setItem('ttpsView', 'table');
    });
    
    // Restore view preference
    const savedView = localStorage.getItem('ttpsView');
    if (savedView === 'table') {
        tableViewBtn?.click();
    }
});

// Show threat details modal
function showThreatDetails(threatId) {
    const modal = new bootstrap.Modal(document.getElementById('threatDetailsModal'));
    const content = document.getElementById('threatDetailsContent');
    
    // Find threat data
    const threatCard = document.querySelector(`[data-id="${threatId}"]`);
    if (!threatCard) return;
    
    const threatName = threatCard.querySelector('.card-title')?.textContent || 'Unknown';
    const threatDesc = threatCard.querySelector('.card-text')?.textContent || 'No description available';
    const severity = threatCard.dataset.severity || 'Unknown';
    const source = threatCard.dataset.source || 'Unknown';
    const tactic = threatCard.dataset.tactic || 'Unknown';
    const mitreId = threatCard.querySelector('.mitre-id')?.textContent || '';
    
    content.innerHTML = `
        <div class="threat-details">
            <div class="row mb-3">
                <div class="col-md-8">
                    <h4>${threatName}</h4>
                    ${mitreId ? `<p class="text-muted">MITRE ATT&CK ID: <code>${mitreId}</code></p>` : ''}
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge severity-${severity.toLowerCase()} fs-6">${severity}</span>
                </div>
            </div>
            
            <div class="mb-4">
                <h6>Description</h6>
                <p>${threatDesc}</p>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <h6>Tactic</h6>
                    <span class="badge bg-secondary">${tactic.replace('-', ' ')}</span>
                </div>
                <div class="col-md-4">
                    <h6>Source</h6>
                    <span class="badge bg-info">${source}</span>
                </div>
                <div class="col-md-4">
                    <h6>Severity</h6>
                    <span class="badge severity-${severity.toLowerCase()}">${severity}</span>
                </div>
            </div>
            
            ${mitreId ? `
            <div class="mb-3">
                <h6>External Resources</h6>
                <button class="btn btn-outline-primary btn-sm" onclick="openMitreLink('${mitreId}')">
                    <i class="fas fa-external-link-alt me-1"></i>View on MITRE ATT&CK
                </button>
            </div>
            ` : ''}
        </div>
    `;
    
    modal.show();
}

// Advanced filters toggle
function toggleAdvancedFilters() {
    const panel = document.querySelector('.advanced-filters');
    const button = document.querySelector('.advanced-filters-toggle');
    
    if (panel.style.display === 'none' || !panel.style.display) {
        panel.style.display = 'block';
        button.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Hide Advanced Filters';
    } else {
        panel.style.display = 'none';
        button.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Show Advanced Filters';
    }
}

// Open MITRE ATT&CK link with correct URL format
function openMitreLink(techniqueId) {
    if (!techniqueId) return;
    
    let url;
    if (techniqueId.includes('.')) {
        // Sub-technique: T1546.012 -> T1546/012
        const [main, sub] = techniqueId.split('.');
        url = `https://attack.mitre.org/techniques/${main}/${sub}/`;
    } else {
        // Main technique: T1546 -> T1546
        url = `https://attack.mitre.org/techniques/${techniqueId}/`;
    }
    
    window.open(url, '_blank', 'noopener,noreferrer');
}

// Make functions available globally
window.showThreatDetails = showThreatDetails;
window.toggleAdvancedFilters = toggleAdvancedFilters;
window.openMitreLink = openMitreLink;
</script>
{% endblock %}